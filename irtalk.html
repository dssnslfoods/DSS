<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IR Talk Registration</title>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; background: #0b1220; color: #e7eefc; }
    .wrap { max-width: 720px; margin: 0 auto; padding: 20px; }
    .card { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.10); border-radius: 16px; padding: 18px; }
    h1 { font-size: 20px; margin: 0 0 10px; }
    .muted { color: rgba(231,238,252,0.75); font-size: 13px; }
    .row { display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 14px; }
    label { font-size: 13px; color: rgba(231,238,252,0.85); }
    input, select, textarea {
      width: 100%; box-sizing: border-box;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      color: #e7eefc;
      padding: 12px 12px;
      border-radius: 12px;
      outline: none;
    }
    input::placeholder { color: rgba(231,238,252,0.45); }
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .actions { display: flex; gap: 10px; align-items: center; margin-top: 14px; }
    button {
      border: 0; border-radius: 12px;
      padding: 12px 14px;
      background: #3b82f6; color: white; font-weight: 600;
      cursor: pointer;
    }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .status {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255,255,255,0.06);
      border: 1px dashed rgba(255,255,255,0.18);
      font-size: 13px;
      white-space: pre-wrap;
    }
    .ok { border-color: rgba(34,197,94,0.45); }
    .err { border-color: rgba(239,68,68,0.55); }
    .badge {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 6px 10px; border-radius: 999px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      font-size: 12px;
    }
    .pdpa { display: flex; gap: 10px; align-items: flex-start; margin-top: 6px; }
    .pdpa input { width: 18px; height: 18px; margin-top: 2px; }
    .small { font-size: 12px; color: rgba(231,238,252,0.75); }
    a { color: #93c5fd; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>ลงทะเบียนเข้าร่วมประชุม (IR Talk)</h1>
      <div class="muted">
        กรุณากรอกข้อมูลให้ครบถ้วน ระบบจะส่งลิงก์ Microsoft Teams กลับผ่าน LINE อัตโนมัติ
      </div>

      <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
        <span class="badge" id="badgeInClient">LIFF: …</span>
        <span class="badge" id="badgeLogin">Login: …</span>
        <span class="badge" id="badgeProfile">Profile: …</span>
      </div>

      <div class="row">
        <div>
          <label>ชื่อ-นามสกุล *</label>
          <input id="fullName" type="text" placeholder="เช่น จริยา ใจไม่ดี" required />
        </div>

        <div class="grid2">
          <div>
            <label>เบอร์โทร</label>
            <input id="phone" type="tel" placeholder="เช่น 0812345678" />
          </div>
          <div>
            <label>อีเมล</label>
            <input id="email" type="email" placeholder="เช่น name@company.com" />
          </div>
        </div>

        <div>
          <label>บริษัท</label>
          <input id="company" type="text" placeholder="เช่น NSL" />
        </div>

        <div class="pdpa">
          <input id="pdpaConsent" type="checkbox" />
          <div>
            <label style="display:block;">ยินยอมให้เก็บและใช้ข้อมูลตาม PDPA *</label>
            <div class="small">
              ข้อมูลจะถูกใช้เพื่อการลงทะเบียนและติดต่อประสานงานการประชุมเท่านั้น
            </div>
          </div>
        </div>

        <div class="actions">
          <button id="submitBtn" disabled>ยืนยันการลงทะเบียน</button>
          <button id="closeBtn" type="button" style="background:#334155;">ปิด</button>
        </div>

        <div id="statusBox" class="status">กำลังเตรียม LIFF…</div>
      </div>
    </div>
  </div>

  <script>
    /**********************
     * CONFIG (แก้ 3 ค่า)
     **********************/
    const LIFF_ID = "2008928307-8xnpCPKG";
    const N8N_WEBHOOK_URL = "https://def2design.app.n8n.cloud/webhook/liff/register";
    const SHARED_SECRET = "nsl-ir-liff-2026-secret-9xAqP!";

    // fixed metadata (optional)
    const SOURCE = "LIFF-IR-TALK";
    const MEETING_TIME_TEXT = "10:00–12:00 น. (เวลาไทย)";

    /**********************
     * STATE
     **********************/
    let lineUserId = null;
    let displayName = null;
    let pictureUrl = null;
    let isInClient = false;

    const $ = (id) => document.getElementById(id);
    const statusBox = $("statusBox");
    const submitBtn = $("submitBtn");

    function setBadge(id, text) {
      $(id).textContent = text;
    }

    function setStatus(text, type) {
      statusBox.textContent = text;
      statusBox.classList.remove("ok", "err");
      if (type === "ok") statusBox.classList.add("ok");
      if (type === "err") statusBox.classList.add("err");
    }

    function canSubmit() {
      const fullName = $("fullName").value.trim();
      const phone = $("phone").value.trim();
      const email = $("email").value.trim();
      const pdpa = $("pdpaConsent").checked;

      // ต้องมี userId + fullName + pdpa + phone/email อย่างน้อย 1
      return !!lineUserId && !!fullName && pdpa && (!!phone || !!email);
    }

    function refreshSubmitState() {
      submitBtn.disabled = !canSubmit();
    }

    async function initLiff() {
      try {
        setStatus("กำลังเริ่มต้น LIFF…");
        await liff.init({ liffId: LIFF_ID });

        isInClient = liff.isInClient();
        setBadge("badgeInClient", `LIFF in-client: ${isInClient ? "true" : "false"}`);

        const loggedIn = liff.isLoggedIn();
        setBadge("badgeLogin", `Logged in: ${loggedIn ? "true" : "false"}`);

        // ถ้าไม่ login ให้ login ก่อน (โดยเฉพาะเปิดนอก LINE)
        if (!loggedIn) {
          setStatus("กำลังพาไปเข้าสู่ระบบ LINE (login) …");
          liff.login(); // จะ redirect แล้วกลับมา
          return;
        }

        // ดึง profile
        const profile = await liff.getProfile();
        lineUserId = profile.userId || null;
        displayName = profile.displayName || null;
        pictureUrl = profile.pictureUrl || null;

        setBadge("badgeProfile", lineUserId ? `Profile OK: ${displayName}` : "Profile: null");

        if (!lineUserId) {
          setStatus(
            "ไม่สามารถดึง LINE userId ได้\n" +
            "- กรุณาเปิดผ่านแอป LINE ด้วยลิงก์ LIFF (https://liff.line.me/...) \n" +
            "- ตรวจสอบว่า LIFF app เปิด scope: profile\n" +
            "- ลองปิดแล้วเปิดใหม่",
            "err"
          );
          refreshSubmitState();
          return;
        }

        setStatus(
          "เชื่อมต่อสำเร็จ ✅\n" +
          `ผู้ใช้: ${displayName}\n` +
          "กรอกแบบฟอร์มแล้วกดยืนยันได้เลย",
          "ok"
        );

        refreshSubmitState();
      } catch (err) {
        console.error(err);
        setStatus(
          "เกิดข้อผิดพลาดในการเริ่มต้น LIFF\n" +
          (err && err.message ? err.message : String(err)),
          "err"
        );
        refreshSubmitState();
      }
    }

    async function submitForm() {
      try {
        submitBtn.disabled = true;

        const fullName = $("fullName").value.trim();
        const phone = $("phone").value.trim();
        const email = $("email").value.trim();
        const company = $("company").value.trim();
        const pdpaConsent = $("pdpaConsent").checked;

        if (!lineUserId) {
          setStatus("ไม่พบ LINE userId กรุณารีเฟรชและเปิดผ่านแอป LINE", "err");
          refreshSubmitState();
          return;
        }
        if (!fullName) {
          setStatus("กรุณากรอกชื่อ-นามสกุล", "err");
          refreshSubmitState();
          return;
        }
        if (!pdpaConsent) {
          setStatus("กรุณายินยอม PDPA ก่อนส่งข้อมูล", "err");
          refreshSubmitState();
          return;
        }
        if (!phone && !email) {
          setStatus("กรุณาระบุเบอร์โทรหรืออีเมลอย่างน้อย 1 อย่าง", "err");
          refreshSubmitState();
          return;
        }

        setStatus("กำลังส่งข้อมูลไปยังระบบ…");

        const payload = {
          // ส่งทั้ง userId และ lineUserId เพื่อความเข้ากันได้กับ n8n
          userId: lineUserId,
          lineUserId: lineUserId,
          displayName,
          pictureUrl,

          fullName,
          phone,
          email,
          company,
          pdpaConsent,

          source: SOURCE,
          meetingTime: MEETING_TIME_TEXT,
          isInClient: isInClient,
          language: (liff.getLanguage && liff.getLanguage()) ? liff.getLanguage() : null,
          timestamp: new Date().toISOString()
        };

        const res = await fetch(N8N_WEBHOOK_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-shared-secret": SHARED_SECRET
          },
          body: JSON.stringify(payload)
        });

        const text = await res.text();
        let data = null;
        try { data = JSON.parse(text); } catch (_) {}

        if (!res.ok) {
          const msg =
            (data && (data.error || data.message)) ? (data.error || data.message)
            : (text || `HTTP ${res.status}`);
          throw new Error(msg);
        }

        setStatus("ส่งข้อมูลสำเร็จ ✅\nระบบจะส่งลิงก์ประชุมกลับทาง LINE ให้คุณ", "ok");

        // ปิดหน้าต่าง LIFF หลัง 1.2 วินาที (ถ้าอยู่ใน LINE)
        setTimeout(() => {
          try {
            if (liff && liff.isInClient && liff.isInClient()) {
              liff.closeWindow();
            }
          } catch (_) {}
        }, 1200);

      } catch (err) {
        console.error(err);
        setStatus(
          "ส่งข้อมูลไม่สำเร็จ ❌\n" +
          (err && err.message ? err.message : String(err)) +
          "\n\n(ถ้ายังไม่หาย: ให้ดู Execution ใน n8n ว่าติดที่ node ไหน)",
          "err"
        );
        refreshSubmitState();
      }
    }

    // events
    $("fullName").addEventListener("input", refreshSubmitState);
    $("phone").addEventListener("input", refreshSubmitState);
    $("email").addEventListener("input", refreshSubmitState);
    $("company").addEventListener("input", refreshSubmitState);
    $("pdpaConsent").addEventListener("change", refreshSubmitState);

    $("submitBtn").addEventListener("click", (e) => {
      e.preventDefault();
      submitForm();
    });

    $("closeBtn").addEventListener("click", () => {
      try {
        if (liff && liff.isInClient && liff.isInClient()) liff.closeWindow();
        else window.close();
      } catch (_) {
        // ignore
      }
    });

    // init
    initLiff();
  </script>
</body>
</html>
