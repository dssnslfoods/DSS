<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NSL IR Connect - Registration</title>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --card:rgba(255,255,255,.06);
      --border:rgba(255,255,255,.12);
      --text:#e7eefc;
      --muted:rgba(231,238,252,.75);
      --blue:#3b82f6;
      --slate:#334155;
      --ok:rgba(34,197,94,.50);
      --err:rgba(239,68,68,.55);
    }
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:760px;margin:0 auto;padding:18px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:18px}
    h1{margin:0 0 8px;font-size:20px}
    .muted{color:var(--muted);font-size:13px;line-height:1.4}
    .badges{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid var(--border);font-size:12px}
    .row{display:grid;grid-template-columns:1fr;gap:12px;margin-top:14px}
    label{font-size:13px;color:rgba(231,238,252,.85)}
    input{
      width:100%;box-sizing:border-box;
      padding:12px 12px;border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.08);
      color:var(--text);outline:none;
    }
    input::placeholder{color:rgba(231,238,252,.45)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .pdpa{display:flex;gap:10px;align-items:flex-start;margin-top:6px}
    .pdpa input{width:18px;height:18px;margin-top:2px}
    .small{font-size:12px;color:var(--muted)}
    .actions{display:flex;gap:10px;align-items:center;margin-top:10px}
    button{
      border:0;border-radius:12px;
      padding:12px 14px;font-weight:700;
      cursor:pointer;
      color:white;
    }
    #submitBtn{background:var(--blue)}
    #closeBtn{background:var(--slate)}
    button:disabled{opacity:.5;cursor:not-allowed}
    .status{
      margin-top:10px;
      padding:10px 12px;border-radius:12px;
      background:rgba(255,255,255,.06);
      border:1px dashed rgba(255,255,255,.18);
      font-size:13px;white-space:pre-wrap;
    }
    .status.ok{border-color:var(--ok)}
    .status.err{border-color:var(--err)}
    details{margin-top:12px}
    summary{cursor:pointer;color:rgba(231,238,252,.85);font-size:13px}
    pre{
      margin:10px 0 0;
      padding:10px 12px;
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px;
      overflow:auto;
      font-size:12px;
      color:rgba(231,238,252,.92)
    }
    a{color:#93c5fd}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>ลงทะเบียนเข้าร่วม Building the Trust: Strategic Operational Excellence & ESG Sustainability
(Online Event)</h1>
      <div class="muted">
        กรุณากรอกข้อมูลให้ครบถ้วน จากนั้นระบบจะส่งลิงก์ Microsoft Teams กลับผ่าน LINE อัตโนมัติ
      </div>

      <div class="badges">
        <span class="badge" id="badgeInClient">inClient: …</span>
        <span class="badge" id="badgeLogin">loggedIn: …</span>
        <span class="badge" id="badgeProfile">profile: …</span>
      </div>

      <div class="row">
        <div>
          <label>ชื่อ-นามสกุล *</label>
          <input id="fullName" type="text" placeholder="เช่น วินัย ใจดี" />
        </div>

        <div class="grid2">
          <div>
            <label>เบอร์โทร</label>
            <input id="phone" type="tel" placeholder="เช่น 0812345678" />
          </div>
          <div>
            <label>อีเมล</label>
            <input id="email" type="email" placeholder="เช่น name@company.com" />
          </div>
        </div>

        <div>
          <label>บริษัท</label>
          <input id="company" type="text" placeholder="เช่น NSL" />
        </div>

        <div class="pdpa">
          <input id="pdpaConsent" type="checkbox" />
          <div>
            <label style="display:block;">ยินยอมให้เก็บและใช้ข้อมูลตาม PDPA *</label>
            <div class="small">ข้อมูลจะใช้เพื่อการลงทะเบียนและติดต่อประสานงานการประชุมเท่านั้น</div>
          </div>
        </div>

        <div class="actions">
          <button id="submitBtn" disabled>ยืนยันการลงทะเบียน</button>
          <button id="closeBtn" type="button">ปิด</button>
        </div>

        <div id="statusBox" class="status">กำลังเริ่มต้น LIFF…</div>

        <details>
          <summary>Debug (สำหรับตรวจสอบ userId / profile)</summary>
          <pre id="debugBox">กำลังโหลด…</pre>
        </details>
      </div>
    </div>
  </div>

  <script>
    /**********************
     * CONFIG (แก้ 3 ค่า)
     **********************/
    const LIFF_ID = "2008928307-8xnpCPKG"; // <-- ถ้าคุณมี LIFF ID แล้ว ใส่ตรงนี้ได้เลย
    const N8N_WEBHOOK_URL = "https://def2design.app.n8n.cloud/webhook/liff/register";
    const SHARED_SECRET = "nsl-ir-liff-2026-secret-9xAqP!";

    // metadata
    const SOURCE = "LIFF-IR-TALK";
    const MEETING_TIME_TEXT = "10:00–12:00 น. (เวลาไทย)";

    /**********************
     * STATE
     **********************/
    let lineUserId = null;
    let displayName = null;
    let pictureUrl = null;

    const $ = (id) => document.getElementById(id);
    const statusBox = $("statusBox");
    const debugBox = $("debugBox");
    const submitBtn = $("submitBtn");

    function setBadge(id, text) { $(id).textContent = text; }

    function setStatus(text, type) {
      statusBox.textContent = text;
      statusBox.classList.remove("ok", "err");
      if (type === "ok") statusBox.classList.add("ok");
      if (type === "err") statusBox.classList.add("err");
    }

    function setDebug(obj) {
      try { debugBox.textContent = JSON.stringify(obj, null, 2); }
      catch { debugBox.textContent = String(obj); }
    }

    function canSubmit() {
      const fullName = $("fullName").value.trim();
      const phone = $("phone").value.trim();
      const email = $("email").value.trim();
      const pdpa = $("pdpaConsent").checked;

      // ต้องมี userId + fullName + pdpa + phone/email อย่างน้อย 1
      return !!lineUserId && !!fullName && pdpa && (!!phone || !!email);
    }

    function refreshSubmitState() {
      submitBtn.disabled = !canSubmit();
    }

    async function initLiff() {
      setStatus("กำลังเริ่มต้น LIFF…");
      setDebug({ step: "init:start" });

      try {
        await liff.init({ liffId: LIFF_ID });

        const inClient = liff.isInClient();
        const loggedIn = liff.isLoggedIn();

        setBadge("badgeInClient", `inClient: ${inClient}`);
        setBadge("badgeLogin", `loggedIn: ${loggedIn}`);

        setDebug({
          step: "init:afterInit",
          inClient,
          loggedIn,
          language: (liff.getLanguage && liff.getLanguage()) ? liff.getLanguage() : null,
          os: (liff.getOS && liff.getOS()) ? liff.getOS() : null,
          version: (liff.getVersion && liff.getVersion()) ? liff.getVersion() : null
        });

        // ถ้าไม่ login ให้ login ก่อน
        if (!loggedIn) {
          setStatus("กำลังเข้าสู่ระบบ LINE (login) …");
          setDebug({ step: "init:loginRedirect" });
          liff.login();
          return;
        }

        // ดึง profile
        let profile = null;
        try {
          profile = await liff.getProfile();
        } catch (e) {
          setStatus("getProfile() error ❌\n" + (e?.message || String(e)) + "\n\nตรวจสอบว่า LIFF scope มี profile", "err");
          setDebug({ step: "init:getProfileError", error: e?.message || String(e) });
          refreshSubmitState();
          return;
        }

        lineUserId = profile?.userId || null;
        displayName = profile?.displayName || null;
        pictureUrl = profile?.pictureUrl || null;

        setBadge("badgeProfile", lineUserId ? `profile: OK (${displayName})` : "profile: null");
        setDebug({ step: "init:profile", profile });

        if (!lineUserId) {
          setStatus(
            "ไม่พบ LINE userId ❌\n" +
            "สาเหตุที่พบบ่อย:\n" +
            "1) LIFF app ยังไม่ได้เปิด scope: profile\n" +
            "2) Endpoint URL ชี้ผิด (ยังเป็นไฟล์เก่า)\n" +
            "3) เปิดไม่ผ่าน liff.line.me\n",
            "err"
          );
          refreshSubmitState();
          return;
        }

        setStatus(
          "เชื่อมต่อสำเร็จ ✅\n" +
          `ผู้ใช้: ${displayName}\n` +
          "กรอกแบบฟอร์มแล้วกดยืนยันได้เลย",
          "ok"
        );

        refreshSubmitState();

      } catch (err) {
        setStatus("LIFF init error ❌\n" + (err?.message || String(err)), "err");
        setDebug({ step: "init:exception", error: err?.message || String(err) });
        refreshSubmitState();
      }
    }

    async function submitForm() {
      try {
        submitBtn.disabled = true;

        const fullName = $("fullName").value.trim();
        const phone = $("phone").value.trim();
        const email = $("email").value.trim();
        const company = $("company").value.trim();
        const pdpaConsent = $("pdpaConsent").checked;

        // Guard
        if (!lineUserId) {
          setStatus("ไม่พบ LINE userId กรุณาเปิดผ่าน LINE OA → ลิงก์ LIFF และตรวจ scope=profile", "err");
          refreshSubmitState();
          return;
        }
        if (!fullName) {
          setStatus("กรุณากรอกชื่อ-นามสกุล", "err");
          refreshSubmitState();
          return;
        }
        if (!pdpaConsent) {
          setStatus("กรุณายินยอม PDPA ก่อนส่งข้อมูล", "err");
          refreshSubmitState();
          return;
        }
        if (!phone && !email) {
          setStatus("กรุณาระบุเบอร์โทรหรืออีเมลอย่างน้อย 1 อย่าง", "err");
          refreshSubmitState();
          return;
        }

        setStatus("กำลังส่งข้อมูลไปยังระบบ…");

        const payload = {
          // ✅ ส่งทั้ง userId และ lineUserId (กัน mismatch ฝั่ง n8n)
          userId: lineUserId,
          lineUserId: lineUserId,
          displayName,
          pictureUrl,

          fullName,
          phone,
          email,
          company,
          pdpaConsent,

          source: SOURCE,
          meetingTime: MEETING_TIME_TEXT,
          isInClient: (liff.isInClient && liff.isInClient()) ? true : false,
          language: (liff.getLanguage && liff.getLanguage()) ? liff.getLanguage() : null,
          timestamp: new Date().toISOString()
        };

        setDebug({ step: "submit:payload", payload });

        const res = await fetch(N8N_WEBHOOK_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-shared-secret": SHARED_SECRET
          },
          body: JSON.stringify(payload)
        });

        const text = await res.text();
        let data = null;
        try { data = JSON.parse(text); } catch (_) {}

        if (!res.ok) {
          const msg =
            (data && (data.error || data.message)) ? (data.error || data.message)
            : (text || `HTTP ${res.status}`);
          throw new Error(msg);
        }

        setStatus(
          "ส่งข้อมูลสำเร็จ ✅\n" +
          "ระบบจะส่งลิงก์ประชุมกลับทาง LINE ให้คุณ",
          "ok"
        );

        setDebug({ step: "submit:success", status: res.status, response: data ?? text });

        // ปิดหน้าต่างใน LINE
        setTimeout(() => {
          try {
            if (liff && liff.isInClient && liff.isInClient()) {
              liff.closeWindow();
            }
          } catch (_) {}
        }, 1200);

      } catch (err) {
        setStatus(
          "ส่งข้อมูลไม่สำเร็จ ❌\n" +
          (err?.message || String(err)) +
          "\n\nให้ดู n8n Executions ว่าติดที่ node ไหน",
          "err"
        );
        setDebug({ step: "submit:error", error: err?.message || String(err) });
        refreshSubmitState();
      }
    }

    // events
    ["fullName","phone","email","company"].forEach(id => {
      $(id).addEventListener("input", refreshSubmitState);
    });
    $("pdpaConsent").addEventListener("change", refreshSubmitState);

    $("submitBtn").addEventListener("click", (e) => {
      e.preventDefault();
      submitForm();
    });

    $("closeBtn").addEventListener("click", () => {
      try {
        if (liff && liff.isInClient && liff.isInClient()) liff.closeWindow();
        else window.close();
      } catch (_) {}
    });

    // start
    initLiff();
  </script>
</body>
</html>
